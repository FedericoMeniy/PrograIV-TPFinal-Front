<div class="usados-page">
  @if(isUserLoggedIn && !esAdmin) {
    <div class="usados-page__cta">
      <button class="usados-page__cta-button" (click)="toggleFormulario()">
        {{ mostrarFormulario ? 'Cancelar' : 'Crear publicación' }}
      </button>
    </div>
  }

  @if(mostrarFormulario && publicacionForm) {
    <section class="formulario-publicacion">
      @if(esAdmin){
        <button type="button"
                class="formulario-publicacion__cerrar"
                (click)="toggleFormulario()">
          Cerrar formulario
        </button>
      }
      <form [formGroup]="publicacionForm" (ngSubmit)="crearPublicacion()">
        <fieldset>
          <legend>Datos de la Publicación</legend>
          <div class="form-row textarea-row">
            <label for="descripcion">Descripción:</label>
            <textarea formControlName="descripcion" id="descripcion" rows="4" placeholder="Ingrese la descripción."></textarea>
            @if(descripcion?.hasError("required") && descripcion?.touched){
              <p class = "msjError">La descripción es obligatoria.</p>
            }@else if(descripcion?.hasError("minlength") && descripcion?.touched){
              <p class = "msjError">La descripción tiene que tener como mínimo 5 caracteres.</p>
            }@else if(descripcion?.hasError("maxlength") && descripcion?.touched){
              <p class = "msjError">La descripcion tiene que tener como máximo 500 caracteres.</p>
            }
          </div>
        </fieldset>

        <fieldset formGroupName="auto">
          <legend>Datos del Auto</legend>
          
          <div class="form-grid">
            <div class="form-row">
              <label for="marca">Marca:</label>
              <input type="text" formControlName="marca" id="marca" placeholder="Ej: Fiat">
              @if(marca?.hasError("required") && marca?.touched){
                <p class = "msjError">La marca es obligatoria.</p>
              }@else if(marca?.hasError("minlength") && marca?.touched){
                <p class = "msjError">Mínimo 2 caracteres.</p>
              }@else if(marca?.hasError("maxlength") && marca?.touched){
                <p class = "msjError">Máximo 30 caracteres.</p>
              }
            </div>

            <div class="form-row">
              <label for="modelo">Modelo:</label>
              <input type="text" formControlName="modelo" id="modelo" placeholder="Ej: Palio">
              @if(modelo?.hasError("required") && modelo?.touched){
                <p class = "msjError">El modelo es obligatorio.</p>
              }@else if(modelo?.hasError("minlength") && modelo?.touched){
                <p class = "msjError">Mínimo 2 caracteres.</p>
              }@else if(modelo?.hasError("maxlength") && modelo?.touched){
                <p class = "msjError">Máximo 30 caracteres.</p>
              }
            </div>

            <div class="form-row">
              <label for="precio">Precio (USD):</label>
              <input type="number" formControlName="precio" id="precio" placeholder="Ej: 10000">
              @if(precio?.hasError("required") && precio?.touched){
                <p class = "msjError">El precio es obligatorio.</p>
              }@else if(precio?.hasError("min") && precio?.touched){
                <p class = "msjError">Mínimo 1 dólar.</p>
              }@else if(precio?.hasError("max") && precio?.touched){
                <p class = "msjError">Máximo 1.000.000 dólares.</p>
              }
            </div>

            <div class="form-row">
              <label for="anio">Año:</label>
              <input type="number" formControlName="anio" id="anio" placeholder="Ej: 2017">
              @if(anio?.hasError("required") && anio?.touched){
                <p class = "msjError">El año es obligatorio.</p>
              }@else if(anio?.hasError("min") && anio?.touched){
                <p class = "msjError">Mínimo 1885.</p>
              }@else if(anio?.hasError("max") && anio?.touched){
                <p class = "msjError">No puede ser mayor al actual.</p>
              }
            </div>

            <div class="form-row">
              <label for="km">Kilometraje:</label>
              <input type="text" formControlName="km" id="km" placeholder="Ej: 88000">
              @if(km?.hasError("required") && km?.touched){
                <p class = "msjError">El kilometraje es obligatorio.</p>
              }@else if(km?.hasError("pattern") && km?.touched){
                <p class = "msjError">Debe ser un número positivo.</p>
              }@else if(km?.hasError("min") && km?.touched){
                <p class = "msjError">El kilometraje debe ser mayor o igual a 0.</p>
              }@else if(km?.hasError("max") && km?.touched){
                <p class = "msjError">Máximo 400.000 km.</p>
              }
            </div>

            <div class="form-row">
              <label for="color">Color:</label>
              <input type="text" formControlName="color" id="color" placeholder="Ej: Negro">
              @if(color?.hasError("required") && color?.touched){
                <p class = "msjError">El color es obligatorio.</p>
              }@else if(color?.hasError("minlength") && color?.touched){
                <p class = "msjError">Mínimo 4 caracteres.</p>
              }@else if(color?.hasError("maxlength") && color?.touched){
                <p class = "msjError">Máximo 8 caracteres.</p>
              }@else if(color?.hasError("pattern") && color?.touched){
                <p class = "msjError">Solo letras.</p>
              }
            </div>
          </div>

          <fieldset formGroupName="fichaTecnica">
            <legend>Ficha Técnica</legend>

            <div class="form-grid">
              <div class="form-row">
                <label for="motor">Motor:</label>
                <input type="text" formControlName="motor" id="motor" placeholder="Ej: 1.8">
                @if(motor?.hasError("required") && motor?.touched){
                  <p class = "msjError">El motor es obligatorio.</p>
                }@else if(motor?.hasError("pattern") && motor?.touched){
                  <p class = "msjError">Debe ser un número positivo.</p>
                }@else if(motor?.hasError("min") && motor?.touched){
                  <p class = "msjError">El motor debe ser mayor o igual a 0.1L.</p>
                }@else if(motor?.hasError("max") && motor?.touched){
                  <p class = "msjError">Máximo 6.6L.</p>
                }
              </div>

              <div class="form-row">
                <label for="combustible">Combustible:</label>
                <select formControlName="combustible" id="combustible">
                  <option value="" disabled>Seleccione</option>
                  @for(comb of tiposCombustible; track comb){
                    <option [value]="comb">{{ comb }}</option>
                  }
                </select>
              </div>

              <div class="form-row">
                <label for="caja">Caja de Cambios:</label>
                <select formControlName="caja" id="caja">
                  <option value="" disabled>Seleccione</option>
                  @for(caja of tiposCaja; track caja){
                    <option [value]="caja">{{ caja }}</option>
                  }
                </select>
              </div>

              <div class="form-row">
                <label for="puertas">Puertas:</label>
                <select formControlName="puertas" id="puertas">
                  <option value="" disabled>Seleccione</option>
                  @for(puerta of tiposPuerta; track puerta){
                    <option [value]="puerta">{{puerta}}</option>
                  }
                </select> 
              </div>

              <div class="form-row">
                <label for="potencia">Potencia:</label>
                <input type="text" formControlName="potencia" id="potencia" placeholder="Ej: 140">
                @if(potencia?.hasError("required") && potencia?.touched){
                  <p class = "msjError">La potencia es obligatoria.</p>
                }@else if(potencia?.hasError("pattern") && potencia?.touched){
                  <p class = "msjError">Debe ser un número positivo.</p>
                }@else if(potencia?.hasError("min") && potencia?.touched){
                  <p class = "msjError">La potencia debe ser mayor o igual a 1 CV.</p>
                }@else if(potencia?.hasError("max") && potencia?.touched){
                  <p class = "msjError">Máximo 400 CV.</p>
                }
              </div>
            </div>
          </fieldset>
        </fieldset>

        <fieldset>
          <legend>Fotos del Vehículo</legend>
          <div class="form-group">
            <label for="imagenes">Seleccionar imágen (DEBE SER JPG):</label>
            <input
              type="file"
              id="imagenes"
              (change)="onFileSelected($event)"
              multiple
              accept="image/png, image/jpeg"
            >
          </div>

          @if (imagePreviews.length > 0) {
            <div class="previews-container">
              <p>Imagen seleccionada:</p>
              <div class="previews-grid">
                @for (preview of imagePreviews; track $index) {
                  <img
                    [src]="preview"
                    alt="Previsualización"
                  >
                }
              </div>
            </div>
          }
        </fieldset>

        <button type="submit" [disabled]="publicacionForm.invalid">
          Guardar Publicación
        </button>
      </form>
    </section>
  }

  <section class="hero-section">
    <div class="hero-content">
      <div class="hero-text">
        <h1>ENCUENTRA TU AUTO USADO IDEAL</h1>
      </div>
      <div class="hero-image">
        <div class="car-platform">
          <i class="fa-solid fa-car-side"></i>
        </div>
      </div>
    </div>
  </section>

  <div class="usados-layout">
    <aside class="filters-sidebar">
      <div class="filter-section">
        <h3 class="filter-title">Precio (USD)</h3>
        <div class="range-slider-container">
          <div class="range-values">
            <span>$ {{ formatearNumero(filtroPrecioMin) }}</span>
            <span>$ {{ formatearNumero(filtroPrecioMax) }}</span>
          </div>
          <input type="range" 
                 class="range-slider" 
                 [min]="0" 
                 [max]="1000000" 
                 step="1000"
                 [(ngModel)]="filtroPrecioMin" 
                 (input)="aplicarFiltros()">
          <input type="range" 
                 class="range-slider" 
                 [min]="0" 
                 [max]="1000000" 
                 step="1000"
                 [(ngModel)]="filtroPrecioMax" 
                 (input)="aplicarFiltros()">
        </div>
      </div>
      
      <div class="filter-section">
        <h3 class="filter-title">Año</h3>
        <div class="range-slider-container">
          <div class="range-values">
            <span>{{ filtroAnioMin }}</span>
            <span>{{ filtroAnioMax }}</span>
          </div>
          <input type="range" 
                 class="range-slider" 
                 [min]="anioMinReal" 
                 [max]="anioMaxReal" 
                 [(ngModel)]="filtroAnioMin" 
                 (input)="aplicarFiltros()">
          <input type="range" 
                 class="range-slider" 
                 [min]="anioMinReal" 
                 [max]="anioMaxReal" 
                 [(ngModel)]="filtroAnioMax" 
                 (input)="aplicarFiltros()">
        </div>
      </div>

      <div class="filter-section">
        <h3 class="filter-title">Kilometraje Máximo</h3>
        <div class="range-slider-container">
          <div class="range-values">
            <span>{{ formatearNumero(filtroKmMax) }} km</span>
          </div>
          <input type="range" 
                 class="range-slider" 
                 [min]="0" 
                 [max]="kmMaxReal" 
                 step="10000"
                 [(ngModel)]="filtroKmMax" 
                 (input)="aplicarFiltros()">
        </div>
      </div>

      <div class="filter-section">
        <h3 class="filter-title">Ordenar por Precio</h3>
        <div class="filter-options">
          <label class="filter-option">
            <input type="radio" name="ordenPrecio" [value]="null" [checked]="ordenPrecio === null" (change)="ordenPrecio = null; aplicarFiltros()">
            <span>Sin ordenar</span>
          </label>
          <label class="filter-option">
            <input type="radio" name="ordenPrecio" value="asc" [checked]="ordenPrecio === 'asc'" (change)="ordenPrecio = 'asc'; aplicarFiltros()">
            <span>Menor a Mayor</span>
          </label>
          <label class="filter-option">
            <input type="radio" name="ordenPrecio" value="desc" [checked]="ordenPrecio === 'desc'" (change)="ordenPrecio = 'desc'; aplicarFiltros()">
            <span>Mayor a Menor</span>
          </label>
        </div>
      </div>

      <div class="filter-section">
        <h3 class="filter-title">Combustible</h3>
        <div class="filter-options">
          @for(comb of tiposCombustible; track comb) {
            <label class="filter-option">
              <input type="checkbox" [value]="comb" [checked]="filtrosCombustible.includes(comb)" (change)="toggleCombustible(comb)">
              <span>{{ comb }}</span>
            </label>
          }
        </div>
      </div>

      <div class="filter-section">
        <h3 class="filter-title">Caja de Cambios</h3>
        <div class="filter-options">
          @for(caja of tiposCaja; track caja) {
            <label class="filter-option">
              <input type="checkbox" [value]="caja" [checked]="filtrosCaja.includes(caja)" (change)="toggleCaja(caja)">
              <span>{{ caja }}</span>
            </label>
          }
        </div>
      </div>

      <div class="filter-section">
        <h3 class="filter-title">Puertas</h3>
        <div class="filter-options">
          @for(puerta of tiposPuerta; track puerta) {
            <label class="filter-option">
              <input type="checkbox" [value]="puerta" [checked]="filtrosPuertas.includes(puerta)" (change)="togglePuertas($any($event.target).value)">
              <span>{{ puerta }} puertas</span>
            </label>
          }
        </div>
      </div>

      <button class="filter-reset-button" (click)="limpiarFiltros()">
        Limpiar Filtros
      </button>
    </aside>

    <section class="listings-usados">
      <header class="listings-usados__header">
        <h2>Fichas de Auto</h2>
        <form class="listings-usados__search" (ngSubmit)="onBusquedaSubmit()">
          <input
            type="text"
            name="busquedaUsados"
            placeholder="Buscar por marca, modelo o vendedor..."
            [(ngModel)]="terminoBusqueda"
          >
          <button type="submit">
            <i class="fa-solid fa-magnifying-glass"></i>
          </button>
        </form>
      </header>

    @if (cargandoUsados) {
      <div class="loading-container">
        <p>Cargando vehículos usados...</p>
      </div>
    } @else {
      <div class="card-container">
      @for (publi of publicacionesUsadosMostradas; track publi.id) {
          <article class="car-card" (click)="mostrarFicha(publi)">
            <div class="card-image">
              <img
                [src]="getImageUrl(publi.auto.imagenesUrl?.[0])"
                alt="Foto de {{ publi.auto.marca }} {{ publi.auto.modelo }}"
              >
            </div>

            <div class="card-content">
              <h3 class="card-title">
                {{ publi.auto.marca }} {{ publi.auto.modelo }}
              </h3>
              <p class="card-price">
                $ {{ publi.auto.precio.toLocaleString('es-AR') }}
              </p>
              <p class="card-details">
                {{ publi.auto.anio }} | {{ publi.auto.km }} km
              </p>
              <p class="card-brand">
                {{ publi.auto.marca }}
              </p>
              <p class="card-vendedor">
                Vendedor: {{ publi.nombreVendedor }}
              </p>
              <p class="card-telefono">
                <a
                  [href]="'https://wa.me/' + publi.vendedorTelefono"
                  target="_blank"
                  rel="noopener noreferrer"
                  (click)="$event.stopPropagation()"
                >
                  WhatsApp
                </a>
              </p>
            </div>
          </article>
        } @empty {
          <p class="listings-usados__empty">
            Aún no hay vehículos usados publicados.
          </p>
        }
      </div>
    }
    </section>
  </div>


      @if (mostrarFichaDetalle && publicacionSeleccionada) {
        <app-ficha-detalle
          [publicacion]="publicacionSeleccionada"
          [deshabilitarReserva]="true"
          (cerrar)="cerrarFicha()"
        ></app-ficha-detalle>
      }
</div>