<div class="usados-page">
  @if (isUserLoggedIn && !esAdmin) {
    <div class="usados-page__cta">
      <button class="usados-page__cta-button" (click)="toggleFormulario()">
        {{ mostrarFormulario ? 'Cancelar' : 'Crear publicación' }}
      </button>
    </div>
  }

  @if (mostrarFormulario && publicacionForm) {
    <section class="formulario-publicacion">
      @if (esAdmin) {
        <button type="button"
                class="formulario-publicacion__cerrar"
                (click)="toggleFormulario()">
          Cerrar formulario
        </button>
      }
      <form [formGroup]="publicacionForm" (ngSubmit)="crearPublicacion()">
        <fieldset>
          <legend>Datos de la Publicación</legend>
          <div class="form-row textarea-row">
            <label for="descripcion">Descripción:</label>
            <textarea
              formControlName="descripcion"
              id="descripcion"
              rows="4"
            ></textarea>
          </div>
        </fieldset>

        <fieldset formGroupName="auto">
          <legend>Datos del Auto</legend>

          <div class="form-row">
            <label for="marca">Marca:</label>
            <input
              type="text"
              formControlName="marca"
              id="marca"
              placeholder="Ej: Toyota"
            >
          </div>

          <div class="form-row">
            <label for="modelo">Modelo y Versión:</label>
            <input
              type="text"
              formControlName="modelo"
              id="modelo"
              placeholder="Ej: Corolla XEI 1.8"
            >
          </div>

          <div class="form-row">
            <label for="precio">Precio (USD):</label>
            <input
              type="number"
              formControlName="precio"
              id="precio"
            >
          </div>

          <div class="form-row">
            <label for="anio">Año:</label>
            <input
              type="number"
              formControlName="anio"
              id="anio"
            >
          </div>

          <div class="form-row">
            <label for="km">Kilometraje:</label>
            <input
              type="text"
              formControlName="km"
              id="km"
              placeholder="Ej: 80.000 km"
            >
          </div>

          <div class="form-row">
            <label for="color">Color:</label>
            <input
              type="text"
              formControlName="color"
              id="color"
            >
          </div>

          <fieldset formGroupName="fichaTecnica">
            <legend>Ficha Técnica</legend>

            <div class="form-row">
              <label for="motor">Motor:</label>
              <input
                type="text"
                formControlName="motor"
                id="motor"
                placeholder="Ej: 1.8L"
              >
            </div>

            <div class="form-row">
              <label for="combustible">Combustible:</label>
              <select formControlName="combustible" id="combustible">
                <option value="" disabled>Seleccione combustible</option>
                @for (comb of tiposCombustible; track comb) {
                  <option [value]="comb">{{ comb }}</option>
                }
              </select>
            </div>

            <div class="form-row">
              <label for="caja">Caja de Cambios:</label>
              <select formControlName="caja" id="caja">
                <option value="" disabled>Seleccione caja</option>
                @for (caja of tiposCaja; track caja) {
                  <option [value]="caja">{{ caja }}</option>
                }
              </select>
            </div>

            <div class="form-row">
              <label for="puertas">Puertas:</label>
              <input
                type="text"
                formControlName="puertas"
                id="puertas"
                placeholder="Ej: 4"
              >
            </div>

            <div class="form-row">
              <label for="potencia">Potencia:</label>
              <input
                type="text"
                formControlName="potencia"
                id="potencia"
                placeholder="Ej: 140cv"
              >
            </div>
          </fieldset>
        </fieldset>

        <fieldset>
          <legend>Fotos del Vehículo</legend>
          <div class="form-group">
            <label for="imagenes">Seleccionar imágen (DEBE SER JPG):</label>
            <input
              type="file"
              id="imagenes"
              (change)="onFileSelected($event)"
              multiple
              accept="image/png, image/jpeg"
            >
          </div>

          @if (imagePreviews.length > 0) {
            <div class="previews-container">
              <p>Imagen seleccionada:</p>
              <div class="previews-grid">
                @for (preview of imagePreviews; track $index) {
                  <img
                    [src]="preview"
                    alt="Previsualización"
                  >
                }
              </div>
            </div>
          }
        </fieldset>

        <button type="submit" [disabled]="publicacionForm.invalid">
          Guardar Publicación
        </button>
      </form>
    </section>
  }

  <section class="listings-usados">
    <header class="listings-usados__header">
      <hr>
    <div class="listings-usados__header-content">
      <h2>Vehículos Usados Disponibles</h2>
      @if (!mostrarBuscador) {
        <button class="listings-usados__filter-button" type="button" (click)="onBuscarClick($event)">
          Buscar usados
        </button>
      } @else {
        <form class="listings-usados__search" (ngSubmit)="onBusquedaSubmit()">
          <input
            type="text"
            name="busquedaUsados"
            placeholder="Buscar por marca, modelo o vendedor..."
            [(ngModel)]="terminoBusqueda"
          >
          <button type="submit">
            <i class="fa-solid fa-magnifying-glass"></i>
          </button>
        </form>
      }
    </div>
    </header>

    @if (cargandoUsados) {
      <div class="loading-container">
        <p>Cargando vehículos usados...</p>
      </div>
    } @else {
      <div class="card-container">
      @for (publi of publicacionesUsadosMostradas; track publi.id) {
          <article class="car-card" (click)="mostrarFicha(publi)">
            <div class="card-image">
              <img
                [src]="publi.auto.imagenesUrl && publi.auto.imagenesUrl.length > 0
                        ? 'http://localhost:8080' + publi.auto.imagenesUrl[0]
                        : 'assets/images/placeholder-auto.png'"
                alt="Foto de {{ publi.auto.marca }} {{ publi.auto.modelo }}"
              >
            </div>

            <div class="card-content">
              <h3 class="card-title">
                {{ publi.auto.marca }} {{ publi.auto.modelo }}
              </h3>
              <p class="card-price">
                $ {{ publi.auto.precio.toLocaleString('es-AR') }}
              </p>
              <p class="card-details">
                {{ publi.auto.anio }} | {{ publi.auto.km }} km
              </p>
              <p class="card-brand">
                {{ publi.auto.marca }}
              </p>
              <p class="card-vendedor">
                Vendedor: {{ publi.nombreVendedor }}
              </p>
              <p class="card-telefono">
                <a
                  [href]="'https://wa.me/' + publi.vendedorTelefono"
                  target="_blank"
                  rel="noopener noreferrer"
                  (click)="$event.stopPropagation()"
                >
                  WhatsApp
                </a>
              </p>
            </div>
          </article>
        } @empty {
          <p class="listings-usados__empty">
            Aún no hay vehículos usados publicados.
          </p>
        }
      </div>
    }
  </section>

  @if (mostrarFichaDetalle && publicacionSeleccionada) {
    <app-ficha-detalle
      [publicacion]="publicacionSeleccionada"
      (cerrar)="cerrarFicha()"
    ></app-ficha-detalle>
  }
</div>