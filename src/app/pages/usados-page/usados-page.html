@if (isUserLoggedIn) {
  <div class="contenedor-crear">
    <button (click)="toggleFormulario()">
      {{ mostrarFormulario ? 'Cancelar' : 'Crear publicacion' }}
    </button>
  </div>
}

@if (mostrarFormulario && publicacionForm) {
  <div class="formulario-publicacion">
    
    <form [formGroup]="publicacionForm" (ngSubmit)="crearPublicacion()">
      
      <fieldset>
        <legend>Datos de la Publicación</legend>
        <div class="textarea-container">
          <label for="descripcion">Descripción:</label>
          <textarea formControlName="descripcion" id="descripcion" rows="4"></textarea>
        </div>
      </fieldset>

      <fieldset formGroupName="auto">
        <legend>Datos del Auto</legend>
        
        <div>
          <label for="marca">Marca:</label>
          <input type="text" formControlName="marca" id="marca" placeholder="Ej: Toyota">
        </div>
        
        <div>
          <label for="modelo">Modelo y Versión:</label>
          <input type="text" formControlName="modelo" id="modelo" placeholder="Ej: Corolla XEI 1.8">
        </div>

        <div>
          <label for="precio">Precio (USD):</label>
          <input type="number" formControlName="precio" id="precio">
          
        </div>

        <div>
          <label for="anio">Año:</label>
          <input type="number" formControlName="anio" id="anio">
        </div>

        <div>
          <label for="km">Kilometraje:</label>
          <input type="text" formControlName="km" id="km" placeholder="Ej: 80.000 km">
        </div>

        <div>
          <label for="color">Color:</label>
          <input type="text" formControlName="color" id="color">
        </div>

        <fieldset formGroupName="fichaTecnica">
          <legend>Ficha Técnica</legend>
          
          <div>
            <label for="motor">Motor:</label>
            <input type="text" formControlName="motor" id="motor" placeholder="Ej: 1.8L">
          </div>

          <div>
            <label for="combustible">Combustible:</label>
            <select formControlName="combustible" id="combustible">
                <option value="" disabled>Seleccione combustible</option>
                @for (comb of tiposCombustible; track comb) {
                  <option [value]="comb">{{ comb }}</option>
                }
            </select>
          </div>

          <div>
            <label for="caja">Caja de Cambios:</label>
            <select formControlName="caja" id="caja">
                <option value="" disabled>Seleccione caja</option>
                @for (caja of tiposCaja; track caja) {
                  <option [value]="caja">{{ caja }}</option>
                }
            </select>
          </div>

          <div>
            <label for="puertas">Puertas:</label>
            <input type="text" formControlName="puertas" id="puertas" placeholder="Ej: 4">
          </div>
          
          <div>
            <label for="potencia">Potencia:</label>
            <input type="text" formControlName="potencia" id="potencia" placeholder="Ej: 140cv">
          </div>

        </fieldset>
      </fieldset>

      <fieldset>
        <legend>Fotos del Vehículo</legend>
        <div class="form-group">
          <label for="imagenes">Seleccionar imágenes (múltiples):</label>
          <input 
            type="file" 
            id="imagenes"
            (change)="onFileSelected($event)" 
            multiple 
            accept="image/png, image/jpeg">
        </div>
        
        @if (imagePreviews.length > 0) {
          <div class="previews-container">
            <p>Imágenes seleccionadas:</p>
            <div class="previews-grid" style="display: flex; flex-wrap: wrap; gap: 10px;">
              @for (preview of imagePreviews; track $index) {
                <img [src]="preview" alt="Previsualización" style="width: 100px; height: 100px; object-fit: cover; border-radius: 5px;">
              }
            </div>
          </div>
        }
      </fieldset>
      <button type="submit" [disabled]="publicacionForm.invalid">Guardar Publicación</button>

    </form>
  </div>
}

<section class="listings-usados" style="padding: 20px;">
  <hr style="margin: 30px 0;">
  <h2>Vehículos Usados Disponibles</h2>
  
  @if (cargandoUsados) {
    <div class="loading-container" style="padding: 20px; text-align: center;">
      <p>Cargando vehículos usados...</p>
    </div>
  } @else {
    <div class="card-container">
      
      @for (publi of publicacionesUsados; track publi.id) {
        <a href="#" class="car-card">
          
          <div class="card-image">
            <img 
              [src]="publi.auto.imagenesUrl && publi.auto.imagenesUrl.length > 0 
                      ? 'http://localhost:8080' + publi.auto.imagenesUrl[0] 
                      : 'assets/images/placeholder-auto.png'" 
              alt="Foto de {{ publi.auto.marca }} {{ publi.auto.modelo }}"
              style="width: 100%; height: 200px; object-fit: cover;">
          </div>
          <div class="card-content">
            <h3 class="card-title">{{ publi.auto.marca }} {{ publi.auto.modelo }}</h3>
            <p class="card-price">$ {{ publi.auto.precio.toLocaleString('es-AR') }}</p>
            <p class="card-details">
              {{ publi.auto.anio }} | {{ publi.auto.km }} km
            </p>
            <p class="card-brand">{{ publi.auto.marca }}</p>

                <p class="card-vendedor">Vendedor: {{ publi.nombreVendedor }}</p>
    
                <p class="card-telefono">
                    <a [href]="'https://wa.me/' + publi.vendedorTelefono" target="_blank" rel="noopener noreferrer">
                       WhatsApp
                    </a>
                </p>
             </div>
        </a>
      } @empty {
        <p style="padding: 20px;">Aún no hay vehículos usados publicados.</p>
      }
    </div>
  }
</section>