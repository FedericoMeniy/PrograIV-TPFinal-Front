@if(usuario) {
<div class="profile-container">

  @if(!isEditing) {
  <div>
    <div class="profile-header">
      <h1>¡Hola, {{ usuario.nombre }}!</h1>
      <button (click)="toggleEdit()" class="btn-edit">Editar Perfil</button>
    </div>
    <p>Estos son los datos de tu perfil:</p>

    <ul>
      <li>
        <strong>Nombre:</strong> {{ usuario.nombre }}
      </li>
      <li><strong>Email:</strong> {{ usuario.email }}</li>
    </ul>

    <button (click)="logout()" class="btn btn-logout">
      Cerrar Sesión
    </button>
  </div>
  }

  @if(isEditing) {
  <div>
    <h1>Editar Perfil</h1>

    <form [formGroup]="editForm" (ngSubmit)="onSave()">
      <ul>
        <li>
          <strong>Nombre:</strong>
          <input formControlName="nombre">
        </li>
        <li><strong>Email:</strong> {{ usuario.email }}</li>
      </ul>

      <div class="form-buttons-group">
        <button type="submit" [disabled]="editForm.invalid" class="btn btn-save">
          Guardar
        </button>
        <button type="button" (click)="toggleEdit()" class="btn btn-cancel">
          Cancelar
        </button>
      </div>
    </form>

  </div>
  }

  <div class="mis-publicaciones-container mt-8">
    <h2 class="text-2xl font-bold mb-4">Mis Publicaciones</h2>

    @if(misPublicaciones.length === 0) {
    <div class="p-4 bg-yellow-100 border border-yellow-400 text-yellow-700 rounded-md">
      Aún no tienes publicaciones activas.
    </div>
    }

    @for(publicacion of misPublicaciones; track publicacion.id) {
    <div class="publicacion-card" (click)="mostrarFicha(publicacion)">
      <div class="card-header">
        <h3 class="text-xl font-semibold">{{ publicacion.auto.marca }} {{ publicacion.auto.modelo }} ({{ publicacion.auto.anio }})</h3>
        <span class="estado-tag estado-{{ publicacion.estado.toLowerCase() }}">{{ publicacion.estado }}</span>
      </div>

      <p><strong>Precio:</strong> ${{ publicacion.auto.precio | number: '1.2-2' }}</p>
      <p><strong>Descripción:</strong> {{ publicacion.descripcion }}</p>
      <p><strong>Kilometraje:</strong> {{ publicacion.auto.km }} km</p>

      <div class="card-actions" (click)="$event.stopPropagation()">
        <button
          (click)="editarPublicacion(publicacion)"
          class="btn-editar"
          title="Editar esta publicación."
        >
          Editar
        </button>
        <button
          (click)="marcarComoVendida(publicacion.id)"
          class="btn-vendida"
        >
          Marcar como Vendida
        </button>
        <button
          (click)="eliminarPublicacion(publicacion.id)"
          class="btn-eliminar"
        >
          Eliminar
        </button>
      </div>
    </div>
    }
  </div>

  @if(editandoPublicacion && publicacionForm) {
    <section class="formulario-publicacion">
      <button type="button"
              class="formulario-publicacion__cerrar"
              (click)="cancelarEdicion()">
        Cerrar formulario
      </button>
      <h2>Editar Publicación</h2>
      <form [formGroup]="publicacionForm" (ngSubmit)="guardarPublicacionEditada()">
        <fieldset>
          <legend>Datos de la Publicación</legend>
          <div class="form-row textarea-row">
            <label for="descripcion">Descripción:</label>
            <textarea formControlName="descripcion" id="descripcion" rows="4" placeholder="Ingrese la descripción."></textarea>
            @if(descripcion?.hasError("minlength") && descripcion?.touched){
              <p class = "msjError">La descripción tiene que tener como mínimo 5 caracteres.</p>
            }@else if(descripcion?.hasError("maxlength") && descripcion?.touched){
              <p class = "msjError">La descripcion tiene que tener como máximo 500 caracteres.</p>
            }
          </div>
        </fieldset>

        <fieldset formGroupName="auto">
          <legend>Datos del Auto</legend>
          
          <div class="form-grid">
            <div class="form-row">
              <label for="marca">Marca:</label>
              <input type="text" formControlName="marca" id="marca" placeholder="Ej: Fiat">
              @if(marca?.hasError("minlength") && marca?.touched){
                <p class = "msjError">Mínimo 2 caracteres.</p>
              }@else if(marca?.hasError("maxlength") && marca?.touched){
                <p class = "msjError">Máximo 30 caracteres.</p>
              }
            </div>

            <div class="form-row">
              <label for="modelo">Modelo:</label>
              <input type="text" formControlName="modelo" id="modelo" placeholder="Ej: Palio">
              @if(modelo?.hasError("minlength") && modelo?.touched){
                <p class = "msjError">Mínimo 2 caracteres.</p>
              }@else if(modelo?.hasError("maxlength") && modelo?.touched){
                <p class = "msjError">Máximo 30 caracteres.</p>
              }
            </div>

            <div class="form-row">
              <label for="precio">Precio (USD):</label>
              <input type="number" formControlName="precio" id="precio" placeholder="Ej: 10000">
              @if(precio?.hasError("min") && precio?.touched){
                <p class = "msjError">Mínimo 0 dólares.</p>
              }@else if(precio?.hasError("max") && precio?.touched){
                <p class = "msjError">Máximo 1.000.000 dólares.</p>
              }
            </div>

            <div class="form-row">
              <label for="anio">Año:</label>
              <input type="number" formControlName="anio" id="anio" placeholder="Ej: 2017">
              @if(anio?.hasError("min") && anio?.touched){
                <p class = "msjError">Mínimo 1885.</p>
              }@else if(anio?.hasError("max") && anio?.touched){
                <p class = "msjError">No puede ser mayor al actual.</p>
              }
            </div>

            <div class="form-row">
              <label for="km">Kilometraje:</label>
              <input type="text" formControlName="km" id="km" placeholder="Ej: 88000">
              @if(km?.hasError("pattern") && km?.touched){
                <p class = "msjError">Debe ser un número positivo.</p>
              }@else if(km?.hasError("min") && km?.touched){
                <p class = "msjError">El kilometraje debe ser mayor o igual a 0.</p>
              }@else if(km?.hasError("max") && km?.touched){
                <p class = "msjError">Máximo 400.000 km.</p>
              }
            </div>

            <div class="form-row">
              <label for="color">Color:</label>
              <input type="text" formControlName="color" id="color" placeholder="Ej: Negro">
              @if(color?.hasError("minlength") && color?.touched){
                <p class = "msjError">Mínimo 4 caracteres.</p>
              }@else if(color?.hasError("maxlength") && color?.touched){
                <p class = "msjError">Máximo 8 caracteres.</p>
              }@else if(color?.hasError("pattern") && color?.touched){
                <p class = "msjError">Solo letras.</p>
              }
            </div>
          </div>

          <fieldset formGroupName="fichaTecnica">
            <legend>Ficha Técnica</legend>

            <div class="form-grid">
              <div class="form-row">
                <label for="motor">Motor:</label>
                <input type="text" formControlName="motor" id="motor" placeholder="Ej: 1.8">
                @if(motor?.hasError("pattern") && motor?.touched){
                  <p class = "msjError">Debe ser un número positivo.</p>
                }@else if(motor?.hasError("min") && motor?.touched){
                  <p class = "msjError">El motor debe ser mayor o igual a 0.1L.</p>
                }@else if(motor?.hasError("max") && motor?.touched){
                  <p class = "msjError">Máximo 6.6L.</p>
                }
              </div>

              <div class="form-row">
                <label for="combustible">Combustible:</label>
                <select formControlName="combustible" id="combustible">
                  <option value="" disabled>Seleccione</option>
                  @for(comb of tiposCombustible; track comb){
                    <option [value]="comb">{{ comb }}</option>
                  }
                </select>
              </div>

              <div class="form-row">
                <label for="caja">Caja de Cambios:</label>
                <select formControlName="caja" id="caja">
                  <option value="" disabled>Seleccione</option>
                  @for(caja of tiposCaja; track caja){
                    <option [value]="caja">{{ caja }}</option>
                  }
                </select>
              </div>

              <div class="form-row">
                <label for="puertas">Puertas:</label>
                <select formControlName="puertas" id="puertas">
                  <option value="" disabled>Seleccione</option>
                  @for(puerta of tiposPuerta; track puerta){
                    <option [value]="puerta">{{puerta}}</option>
                  }
                </select> 
              </div>

              <div class="form-row">
                <label for="potencia">Potencia:</label>
                <input type="text" formControlName="potencia" id="potencia" placeholder="Ej: 140">
                @if(potencia?.hasError("pattern") && potencia?.touched){
                  <p class = "msjError">Debe ser un número positivo.</p>
                }@else if(potencia?.hasError("min") && potencia?.touched){
                  <p class = "msjError">La potencia debe ser mayor o igual a 1 CV.</p>
                }@else if(potencia?.hasError("max") && potencia?.touched){
                  <p class = "msjError">Máximo 400 CV.</p>
                }
              </div>
            </div>
          </fieldset>
        </fieldset>

        <fieldset>
          <legend>Fotos del Vehículo</legend>
          <div class="form-group">
            <label for="imagenes">Seleccionar nuevas imágenes (opcional, DEBE SER JPG):</label>
            <input
              type="file"
              id="imagenes"
              (change)="onFileSelected($event)"
              multiple
              accept="image/png, image/jpeg"
            >
          </div>

          @if (imagePreviews.length > 0) {
            <div class="previews-container">
              <p>Imágenes actuales y nuevas:</p>
              <div class="previews-grid">
                @for (preview of imagePreviews; track $index) {
                  <img
                    [src]="preview"
                    alt="Previsualización"
                  >
                }
              </div>
            </div>
          }
        </fieldset>

        <button type="submit">
          Guardar Cambios
        </button>
      </form>
    </section>
  }

      @if (mostrarFichaDetalle && publicacionSeleccionada) {
        <app-ficha-detalle
          [publicacion]="publicacionSeleccionada"
          [deshabilitarReserva]="true"
          (cerrar)="cerrarFicha()"
        ></app-ficha-detalle>
      }

      <app-confirm-dialog
        [message]="mensajeConfirmacion"
        [show]="mostrarConfirmDialog"
        (confirm)="onConfirmarEliminacion()"
        (cancel)="onCancelarEliminacion()"
      ></app-confirm-dialog>

</div>
}

@if(!usuario) {
<div>
  <p>No se pudieron cargar los datos del perfil. Por favor, inicia sesión.</p>
</div>
}